# Bot Deployment Task Dev Spec One-Pager

## Summary
The task wraps the [AZ CLI](https://docs.microsoft.com/en-us/cli/azure/?view=azure-cli-latest) deployment commands to deploy a bot in Azure using the [Azure Resource Manager templates](https://azure.microsoft.com/en-in/documentation/articles/resource-group-template-deploy/), and to connect the bot with channels as Direct Line or Slack.

Works on cross-platform Azure Pipelines agents running Windows, Linux or Mac and it can be used for deploying ASP.NET and Node.js based bot applications.

## Requirements
#### Azure Subscription 
To deploy to Azure, an Azure subscription has to be linked to Team Foundation Server or to Azure Pipelines using the Services tab in the Account Administration section.

### Prerequisites
- azure-pipelines-task-lib library

### Use Cases
These are some of the possible use cases:

- Deployment with Validation Mode (no resources will be deployed).
- Deployment with an ARM parameters file. 
- Deployment with an ARM parameters file and overriding some parameters.
- Deployment connecting the bot with the Direct Line and MS Teams channels.
- Deployment connecting the bot with the Slack channel.

## Design Specifications
The UI of the task keeps consistency with the Azure Pipeline Tasks style. Also maintains most of their input's names.

### Parameters of the task
The parameters listed with a \* are required for the task:

 * **Azure Subscription**\*: The service connection name linked with the Azure Subscription where the resources will be created.
 
 * **Deployment Scope**\*: The scope for the deployment. It could be a deployment to a _Subscription_ level or to a _Resource Group_.

 * **Resource Group**\*: The name for the resource group.
 
 * **Location**\*: The location where the resource group will be created.

 * **Template**\*: Full path or a pattern pointing for the [Azure Resources Manager](https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/) template file.

 * **Template Parameters**: Full path or a pattern pointing for the parameters file for the Azure Resource Manager template.

 * **Override Template Parameters**: A grid to override any parameter of the parameters file. The name and value of the parameter should be provided.

  * **Validation Mode**: Enables a syntactical validation of the template before creating actual resources. 

 * **Zipped bot**\*: File path to the package or a folder containing the bot's project generated by MSBuild or a compressed zip file.

 * **Connection with Channels**
    - **Direct Line**: Connects the bot with Direct Line.
    - **Slack**: Connects the bot with Slack.
    - **Teams**: Connects the bot with MS Teams.
    - **Webex**: Connects the bot with Webex.
    - **Facebook**: Connects the bot with Facebook.
    - **Twilio**: Connects the bot with Twilio.
    
    _Note: Slack, Webex, Facebook and Twilio need extra credentials that will be required once the check box is selected._

## WorkFlow
The task's workflow 

**Login to Azure**: Run _az login_ command.

If **Validation Mode = true**
- Run _az deployment validate_ command.

 
If **Validation Mode = false**
- Check **Resource Group existence**: Run _az group exists_ command. If it doesn't exist: Run _az group create_ command.
 
- **Resources Deployment**

  - Scope _**Resource Group**_: Run _az group deployment create_ command.
  - Scope _**Subscription**_: Run _az deployment create_ command.
 
- **Bot Deployment**: Run _az webapp deployment source config-zip_ command.
 
- **Connection with Channels**:

   - Direct Line: Run _az bot directline create_ command.
   - MS Teams: Run _az bot msteams create_ command.
   - Slack: add the Slack extra parameters to the Resources Deployment step.
   - Webex: add the Webex extra parameters to the Resources Deployment step.
   - Facebook: add the Facebook extra parameters to the Resources Deployment step.
   - Twilio: add the Twilio extra parameters to the Resources Deployment step.

**Finish** execution.

## Special Considerations
The connection with the Slack, Twilio, Facebook and Webex channels is made through the [BotFramework SDK Adapters](https://github.com/microsoft/botbuilder-dotnet/tree/master/libraries/Adapters). Therefore, the deployed bot must include the corresponding adapters to connect with these channels. 

## Issues
- TODO: Add telemetry to identify the use of the AZ CLI throughout the task.